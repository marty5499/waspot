<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <script src="waspot.js"></script>
  <script src="opencv.js"></script>
  <script src="webduino-all-0.4.20.min.js"></script>
  <script src="webduino-blockly.min.js"></script>
</head>

<body style='margin:0px'>
  <canvas id='c1' width=478 height=316></canvas>
  <script>
  var buzzer;
  var rgbled;
  var entry = false;
  var hot = new HotBlock('c1');

  boardReady({ board: 'Smart', device: 'LaGWa', transport: 'mqtt' }, function (board) {
    board.samplingInterval = 50;
    buzzer = getBuzzer(board, 14);
    rgbled = getRGBLedCathode(board, 15, 12, 13);
    //門口 "area": [280, 150, 420, 290]
    hot.addBlock({
      "id": "default",
      "area": [280, 150, 420, 290],
      "history": 2000,
      "varThreshold": 200,
      "learningRate": 0.005,
      "detectShadows": false,
      "objMinSize": 70,
      "filter": ["e5", "g3","d3"]
    }, {
      inside: function (pos, c) {
        var ctx = c.getContext("2d");
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, pos.radius, 0, 2 * Math.PI);
        ctx.stroke();
        this.setStroke(3, "#00FF00");
        rgbled.setColor('#00ff00');
        if (!enter) {
          enter = true;
          play();
        }
      },
      outside: function (pos) {
        enter = false;
        this.setStroke(3, "#FF0000");
        rgbled.setColor('#000000');
      }
    });
  });

  hot.startAfter(3000);
  //var cam = new Camera("http://cam99.local:81/stream");
  //var cam = new Camera("http://webduino.tw/view/cam22");
  //var cam = new Camera('http://cam22.local/jpg?0.1');
  var cam = new Camera('http://webeye.webduino.io/camera/wrPlZr60d/live');
  cam.onCanvas('c1', function (canvas) {
    hot.scan();
  });


  function play() {
    buzzer.play(buzzer_music([{ notes: ["C6", "e6"], tempos: ["8", "8"] }]).notes, buzzer_music([{ notes: ["C6", "e6"], tempos: ["8", "8"] }]).tempos);

  }

  function buzzer_music(m) {
    var musicNotes = {};
    musicNotes.notes = [];
    musicNotes.tempos = [];
    if (m[0].notes.length > 1) {
      for (var i = 0; i < m.length; i++) {
        if (Array.isArray(m[i].notes)) {
          var cn = musicNotes.notes.concat(m[i].notes);
          musicNotes.notes = cn;
        } else {
          musicNotes.notes.push(m[i].notes);
        }
        if (Array.isArray(m[i].tempos)) {
          var ct = musicNotes.tempos.concat(m[i].tempos);
          musicNotes.tempos = ct;
        } else {
          musicNotes.tempos.push(m[i].tempos);
        }
      }
    } else {
      musicNotes.notes = [m[0].notes];
      musicNotes.tempos = [m[0].tempos];
    }
    return musicNotes;
  }
  </script>
</body>

</html>